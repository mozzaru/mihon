name: Java CI

on:
  push:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@main
      with:
        submodules: true
        fetch-depth: 1

    - name: Set up JDK 24
      uses: actions/setup-java@main
      with:
        java-version: 24
        distribution: temurin

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Install build-tools
      run: |
        yes | sdkmanager --install "build-tools;34.0.0"

    - name: Add build-tools to PATH
      run: echo "${ANDROID_HOME}/build-tools/34.0.0" >> $GITHUB_PATH

    - name: Decode keystore
      run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore

    - name: Get version
      id: version
      run: |
        VERSION=$(grep --only-matching --perl-regexp 'versionName\s=\s\"\K([0-9\.]+)' './app/build.gradle.kts')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    
    # Build arm64-v8a
    - name: Build arm64-v8a APK
      run: ./gradlew --no-daemon clean assembleRelease -PabiFilter=arm64-v8a

    - name: Sign arm64-v8a APK
      run: |
        for apk in ./app/build/outputs/apk/release/*.apk; do
          apksigner sign \
            --ks release.keystore \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out "Mihon-arm64-v8a-v${{ env.VERSION }}.apk" "$apk"
        done

    - name: Upload arm64-v8a APK
      uses: actions/upload-artifact@main
      with:
        name: "Mihon-arm64-v8a-v${{ env.VERSION }}"
        path: Mihon-arm64-v8a-v${{ env.VERSION }}.apk
    
    # Build armeabi-v7a
    - name: Build armeabi-v7a APK
      run: ./gradlew --no-daemon clean assembleRelease -PabiFilter=armeabi-v7a

    - name: Sign armeabi-v7a APK
      run: |
        for apk in ./app/build/outputs/apk/release/*.apk; do
          apksigner sign \
            --ks release.keystore \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out "Mihon-armeabi-v7a-v${{ env.VERSION }}.apk" "$apk"
        done

    - name: Upload armeabi-v7a APK
      uses: actions/upload-artifact@main
      with:
        name: "Mihon-armeabi-v7a-v${{ env.VERSION }}"
        path: Mihon-armeabi-v7a-v${{ env.VERSION }}.apk